version: '3.8'
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NODE_ENV=production
    image: gangrunprinting:v1
    container_name: gangrunprinting_app
    ports:
      - "3002:3002"
    env_file:
      - .env
    environment:
      # Node.js settings
      - NODE_ENV=production
      - PORT=3002
      - HOSTNAME=0.0.0.0
      - TZ=America/Chicago
      
      # Database - PostgreSQL
      - DATABASE_URL=${DATABASE_URL:-postgresql://gangrun_user:GangRun2024Secure@172.22.0.1:5432/gangrun_db}
      
      # Redis
      - REDIS_URL=${REDIS_URL:-redis://redis_cache:6379}
      # Auth (Lucia)
      - AUTH_SECRET=${AUTH_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-https://gangrunprinting.com}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-https://gangrunprinting.com}
      - AUTH_TRUST_HOST=true
      
      # OAuth Providers (optional)
      - AUTH_GOOGLE_ID=${AUTH_GOOGLE_ID}
      - AUTH_GOOGLE_SECRET=${AUTH_GOOGLE_SECRET}
      # Admin
      - ADMIN_EMAIL=${ADMIN_EMAIL:-iradwatkins@gmail.com}
      
      # Square Payments (Primary)
      - SQUARE_ACCESS_TOKEN=${SQUARE_ACCESS_TOKEN}
      - SQUARE_ENVIRONMENT=${SQUARE_ENVIRONMENT:-production}
      - SQUARE_LOCATION_ID=${SQUARE_LOCATION_ID}
      - SQUARE_APPLICATION_ID=${SQUARE_APPLICATION_ID}
      - SQUARE_WEBHOOK_SIGNATURE_KEY=${SQUARE_WEBHOOK_SIGNATURE_KEY}
      - NEXT_PUBLIC_SQUARE_APPLICATION_ID=${NEXT_PUBLIC_SQUARE_APPLICATION_ID}
      - NEXT_PUBLIC_SQUARE_LOCATION_ID=${NEXT_PUBLIC_SQUARE_LOCATION_ID}
      # MinIO Storage (Docker networking)
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-gangrun_minio_access}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-gangrun_minio_secret_2024}
      - MINIO_USE_SSL=false
      - MINIO_BUCKET_NAME=gangrun-products

      # Cloudflare R2 Storage (fallback)
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME:-gangrun-files}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}
      
      # Email (Resend)
      - RESEND_API_KEY=${RESEND_API_KEY}
      - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL:-support@gangrunprinting.com}
      - RESEND_FROM_NAME=${RESEND_FROM_NAME:-GangRun Printing}
      # PWA
      - NEXT_PUBLIC_VAPID_PUBLIC_KEY=${NEXT_PUBLIC_VAPID_PUBLIC_KEY}
      - VAPID_PRIVATE_KEY=${VAPID_PRIVATE_KEY}
      - VAPID_SUBJECT=${VAPID_SUBJECT:-mailto:support@gangrunprinting.com}
      
      # Bull Queue
      - BULL_REDIS_HOST=redis_cache
      - BULL_REDIS_PORT=6379
    volumes:
      - uploads:/app/uploads
      - print_files:/app/print-files
      - ./public:/app/public
      - ./prisma:/app/prisma:ro
    networks:
      - web_network
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - wget
        - '--no-verbose'
        - '--tries=1'
        - '--spider'
        - http://localhost:3002/api/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  uploads:
    driver: local
  print_files:
    driver: local

networks:
  web_network:
    external: true
