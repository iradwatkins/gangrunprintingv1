version: '3.8'

networks:
  new_web_network:
    external: true

services:
  app:
    image: gangrunprinting:new
    container_name: new_gangrunprinting_app
    restart: unless-stopped
    expose:
      - '3002'
    environment:
      - NODE_ENV=production
      - PORT=3002
      - DATABASE_URL=postgresql://iradwatkins:Iw2006js!@172.30.0.10:5432/gangrun_db
      - REDIS_URL=redis://172.30.0.11:6379
      - NEXTAUTH_URL=https://gangrunprinting.com
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      # Square Configuration
      - SQUARE_ACCESS_TOKEN=${SQUARE_ACCESS_TOKEN}
      - SQUARE_ENVIRONMENT=production
      - SQUARE_LOCATION_ID=${SQUARE_LOCATION_ID}
      - SQUARE_APPLICATION_ID=${SQUARE_APPLICATION_ID}
      - SQUARE_WEBHOOK_SIGNATURE=${SQUARE_WEBHOOK_SIGNATURE}
      # Cloudflare R2 Configuration
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      # Email Configuration
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - EMAIL_FROM=noreply@gangrunprinting.com
    volumes:
      - ./uploads:/app/uploads
    networks:
      new_web_network:
        ipv4_address: 172.30.0.21
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3002/api/health']
      interval: 30s
      timeout: 10s
      retries: 5
    depends_on:
      - postgres
      - redis
