**20\. Development: Order History & Details Page\*\***

This step implements the "My Account" section where users can view their order history and the details of a specific order. This is a core part of **\*\*Epic 4: Customer Account Management\*\*** and uses the designs provided as a visual guide.

**\*\*Actions Taken:\*\***

1\. **\*\*Create API Functions:\*\*** New secure API functions, \`getOrderHistory\` and \`getOrderDetails\`, are created. These functions use the user's JWT to fetch only the orders that belong to the currently authenticated user from the Supabase backend.  
2\. **\*\*Build Order History Page:\*\*** The \`OrderHistoryPage\` component is built. It calls \`getOrderHistory\` using **\*\*React Query\*\*** and displays the orders in a table, including the order number, date, total, and status, as required by the UI/UX Specification.  
3\. **\*\*Build Order Detail Page:\*\*** The \`OrderDetailPage\` component is built. It fetches all details for a single order, including the full \`configuration\` and \`price_summary\` snapshots for each job, and displays them in a clear, itemized format.

Here is the code for the new **\*\*Order API functions\*\***:

\`\`\`typescript  
// File: src/api/orders.ts

import { supabase } from "@/lib/supabaseClient";

// Fetches a summary of all orders for the current user  
export const getOrderHistory \= async () \=\> {  
 const { data, error } \= await supabase  
 .from('orders')  
 .select('id, created_at, reference_number, status, pricing_totals') //  
 .order('created_at', { ascending: false });

if (error) throw new Error(error.message);  
 return data;  
};

// Fetches all details for a single order, including its line items (jobs)  
export const getOrderDetails \= async (orderId: string) \=\> {  
 const { data, error } \= await supabase  
 .from('orders')  
 .select(\`  
 \*,  
 order_jobs ( \* )  
 \`) //  
 .eq('id', orderId)  
 .single();

if (error) throw new Error(error.message);  
 return data;  
};  
\`\`\`

Here is the code for the **\*\*Order History Page\*\***:

\`\`\`typescript  
// File: src/pages/account/OrderHistoryPage.tsx

import { useQuery } from '@tanstack/react-query';  
import { getOrderHistory } from '@/api/orders';  
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';  
import { Link } from 'react-router-dom';

export function OrderHistoryPage() {  
 const { data: orders, isLoading, isError } \= useQuery({  
 queryKey: \['orderHistory'\],  
 queryFn: getOrderHistory,  
 });

if (isLoading) return \<div className="p-8"\>\<span\>Loading order history...\</span\>\</div\>;  
 if (isError) return \<div className="p-8"\>\<span\>Error loading orders.\</span\>\</div\>;

return (  
 \<div className="p-8"\>  
 \<h1 className="text-3xl font-bold mb-6"\>My Orders\</h1\>  
 \<Table\>  
 \<TableHeader\>  
 \<TableRow\>  
 \<TableHead\>Order \#\</TableHead\>  
 \<TableHead\>Date\</TableHead\>  
 \<TableHead\>Status\</TableHead\>  
 \<TableHead\>Total\</TableHead\>  
 \</TableRow\>  
 \</TableHeader\>  
 \<TableBody\>  
 {orders?.map(order \=\> (  
 \<TableRow key={order.id}\>  
 \<TableCell\>  
 \<Link to={\`/account/orders/${order.id}\`} className="text-primary hover:underline"\>  
                  {order.reference\_number}  
                \</Link\>  
              \</TableCell\>  
              \<TableCell\>{new Date(order.created\_at).toLocaleDateString()}\</TableCell\>  
              \<TableCell\>{order.status}\</TableCell\>  
              \<TableCell\>${order.pricing_totals?.grand_total.toFixed(2)}\</TableCell\>  
 \</TableRow\>  
 ))}  
 \</TableBody\>  
 \</Table\>  
 \</div\>  
 );  
}  
\`\`\`
