**19\. Development: Checkout Page & Order Creation\*\***

This step implements the checkout process, which is the culmination of **\*\*Epic 3\*\***. It involves creating the checkout page where users enter their address information and the secure backend function that saves the cart contents as a formal order in the database.

**\*\*Actions Taken:\*\***

1\. **\*\*Create Backend Order Function:\*\*** A new **\*\*Supabase Edge Function\*\*** is created to handle order creation. This is a critical, protected operation. The function wraps all database inserts within a **\*\*transaction\*\*** to ensure data integrity; either the entire order is created successfully, or all changes are rolled back.  
2\. **\*\*Generate Reference Number:\*\*** The backend function generates a unique \`Customer Reference / Invoice Number\` in the specified \`GRP-12345\` format for each new order.  
3\. **\*\*Build Checkout Page UI:\*\*** The \`CheckoutPage.tsx\` component is built. It displays the final cart summary and includes forms for shipping and billing addresses using **\*\*React Hook Form\*\***.  
4\. **\*\*Implement Order Submission:\*\*** When the user clicks "Place Order," the frontend calls the \`create-order\` edge function, passing the user's session and cart details. Upon success, the client-side cart is cleared, and the user is redirected to the order confirmation page.

Here is the code for the **\*\*Supabase Edge Function\*\*** to create an order:

\`\`\`typescript  
// File: supabase/functions/create-order/index.ts

import { serve } from "\[https://deno.land/std@0.168.0/http/server.ts\](https://deno.land/std@0.168.0/http/server.ts)"  
import { createClient } from '\[https://esm.sh/@supabase/supabase-js@2\](https://esm.sh/@supabase/supabase-js@2)'

serve(async (req) \=\> {  
 try {  
 // 1\. Get user and cart data from the request  
 const { cartItems, shippingAddress } \= await req.json();  
 const supabase \= createClient(Deno.env.get('SUPABASE_URL')\!, Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')\!);

    // Get user from JWT
    const { data: { user } } \= await supabase.auth.getUser();
    if (\!user) throw new Error("User not authenticated.");

    // 2\. Call the 'create\_new\_order' RPC function which handles the transaction
    const { data, error } \= await supabase.rpc('create\_new\_order', {
      user\_id: user.id,
      order\_jobs\_data: cartItems, // Pass cart items to the function
      shipping\_address\_data: shippingAddress
    });

    if (error) throw error;

    return new Response(JSON.stringify({ orderId: data }), {
      headers: { "Content-Type": "application/json" },
    });

} catch (error) {  
 return new Response(JSON.stringify({ error: error.message }), {  
 status: 400,  
 headers: { "Content-Type": "application/json" },  
 });  
 }  
})

// Corresponding PostgreSQL function to handle the transaction  
/\*  
 This SQL would be in a separate migration file. It defines the function  
 that the Edge Function calls. This ensures the multi-step insert  
 is atomic (all or nothing).  
\*/  
\-- CREATE OR REPLACE FUNCTION create_new_order(  
\-- user_id uuid,  
\-- order_jobs_data jsonb,  
\-- shipping_address_data jsonb  
\-- ) RETURNS bigint AS $$  
\-- DECLARE  
\-- new_order_id bigint;  
\-- job jsonb;  
\-- BEGIN  
\-- \-- Insert into orders table and get the new order's ID  
\-- INSERT INTO orders (customer_id, shipping_address, reference_number)  
\-- VALUES (user_id, shipping_address_data, 'GRP-' || LPAD(nextval('order_ref_seq')::text, 5, '0'))  
\-- RETURNING id INTO new_order_id;

\-- \-- Loop through the JSON array of jobs and insert them  
\-- FOR job IN SELECT \* FROM jsonb_array_elements(order_jobs_data)  
\-- LOOP  
\-- INSERT INTO order_jobs (order_id, product_id, configuration, price_summary, quantity)  
\-- VALUES (  
\-- new_order_id,  
\-- (job-\>\>'productId')::bigint,  
\-- (job-\>'configuration')::jsonb,  
\-- (job-\>'price')::jsonb,  
\-- (job-\>\>'quantity')::int  
\-- );  
\-- END LOOP;

\-- RETURN new_order_id;  
\-- END;  
\-- $$ LANGUAGE plpgsql;  
\`\`\`

Here is the code for the **\*\*Checkout Page\*\***:

\`\`\`typescript  
// File: src/pages/CheckoutPage.tsx

import { useForm } from 'react-hook-form';  
import { useCartStore } from '@/store/cartStore';  
import { useAuth } from '@/providers/auth-provider';  
import { Button } from '@/components/ui/button';  
import { Input } from '@/components/ui/input';  
import { Label } from '@/components/ui/label';  
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';  
import { useNavigate } from 'react-router-dom';

type AddressFormData \= {  
 fullName: string;  
 streetAddress: string;  
 city: string;  
 state: string;  
 zipCode: string;  
};

export function CheckoutPage() {  
 const { items: cartItems, clearCart } \= useCartStore();  
 const { session } \= useAuth();  
 const navigate \= useNavigate();  
 const { register, handleSubmit } \= useForm\<AddressFormData\>();  
 const totalPrice \= cartItems.reduce((total, item) \=\> total \+ item.price \* item.quantity, 0);

const onSubmit \= async (data: AddressFormData) \=\> {  
 if (\!session) {  
 alert("You must be logged in to check out.");  
 return;  
 }

    try {
      // Call the edge function to create the order
      const response \= await fetch('/api/v1/create-order', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': \`Bearer ${session.access\_token}\`
        },
        body: JSON.stringify({ cartItems, shippingAddress: data })
      });

      const result \= await response.json();
      if (\!response.ok) throw new Error(result.error);

      // On success...
      clearCart();
      navigate(\`/order-confirmed?orderId=${result.orderId}\`);

    } catch (error: any) {
      alert(\`Error placing order: ${error.message}\`);
    }

};

return (  
 \<div className="p-8 grid md:grid-cols-2 gap-8"\>  
 \<section\>  
 \<Card\>  
 \<CardHeader\>\<CardTitle\>Shipping Address\</CardTitle\>\</CardHeader\>  
 \<CardContent\>  
 \<form id="checkout-form" onSubmit={handleSubmit(onSubmit)} className="space-y-4"\>  
 {/\* Form fields for address data \*/}  
 \<div\>\<Label\>Full Name\</Label\>\<Input {...register('fullName')} /\>\</div\>  
 \<div\>\<Label\>Street Address\</Label\>\<Input {...register('streetAddress')} /\>\</div\>  
 {/\* ... other address fields \*/}  
 \</form\>  
 \</CardContent\>  
 \</Card\>  
 \</section\>

      \<section className="space-y-6"\>
        \<Card\>
          \<CardHeader\>\<CardTitle\>Order Summary\</CardTitle\>\</CardHeader\>
          \<CardContent\>
            {/\* Display cart items here \*/}
            \<div className="text-xl font-bold flex justify-between"\>
              \<span\>Total\</span\>
              \<span\>${totalPrice.toFixed(2)}\</span\>
            \</div\>
          \</CardContent\>
        \</Card\>
        \<Button type="submit" form="checkout-form" size="lg" className="w-full"\>
          Place Order
        \</Button\>
      \</section\>
    \</div\>

);  
}  
\`\`\`
