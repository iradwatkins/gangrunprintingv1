**21\. Development: Admin Panel \- Order Management\*\***

This step implements the first part of the administrative back-office, as defined in **\*\*Epic 5\*\***. It creates a secure page where administrators can view all customer orders and update their statuses (e.g., from "Production" to "Shipped").

**\*\*Actions Taken:\*\***

1\.  **\*\*Create Secure Admin API:\*\*** New API functions are created specifically for admin use. These functions will be protected by backend logic that verifies the user has an 'admin' role before returning data, as required by the system architecture.  
2\.  **\*\*Build Admin Orders Page:\*\*** A new \`AdminOrdersPage.tsx\` component is created. It uses **\*\*React Query\*\*** to fetch a list of all orders on the platform.  
3\.  **\*\*Implement Status Updates:\*\*** The page includes functionality for an admin to change an order's status. This is handled by a \`useMutation\` hook from React Query, which calls a secure backend function to update the order in the database. This fulfills the requirement for admins to manage the complete order lifecycle.

Here is the code for the new **\*\*Admin API functions\*\***:

\`\`\`typescript  
// File: src/api/admin/orders.ts

import { supabase } from "@/lib/supabaseClient";

// Fetches ALL orders for the admin view.  
// A real implementation would include server-side RLS policies  
// or an edge function to ensure only admins can call this.  
export const getAdminOrderList \= async () \=\> {  
  const { data, error } \= await supabase  
    .from('orders')  
    .select('id, created\_at, reference\_number, status, pricing\_totals')  
    .order('created\_at', { ascending: false });

  if (error) throw new Error(error.message);  
  return data;  
};

// Updates the status of a specific order.  
export const updateOrderStatus \= async ({ orderId, newStatus }: { orderId: number, newStatus: string }) \=\> {  
  const { data, error } \= await supabase  
    .from('orders')  
    .update({ status: newStatus, updated\_at: new Date().toISOString() })  
    .eq('id', orderId)  
    .select()  
    .single();  
      
  if (error) throw new Error(error.message);  
  return data;  
}  
\`\`\`

Here is the code for the **\*\*Admin Order Management Page\*\***:

\`\`\`typescript  
// File: src/pages/admin/AdminOrdersPage.tsx

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';  
import { getAdminOrderList, updateOrderStatus } from '@/api/admin/orders';  
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';  
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';  
import { Button } from '@/components/ui/button';

export function AdminOrdersPage() {  
  const queryClient \= useQueryClient();

  const { data: orders, isLoading } \= useQuery({  
    queryKey: \['adminOrders'\],  
    queryFn: getAdminOrderList,  
  });

  const updateStatusMutation \= useMutation({  
    mutationFn: updateOrderStatus,  
    onSuccess: () \=\> {  
      // When an update is successful, refetch the orders list to show the new status  
      queryClient.invalidateQueries({ queryKey: \['adminOrders'\] });  
    },  
  });

  const handleStatusChange \= (orderId: number, newStatus: string) \=\> {  
    updateStatusMutation.mutate({ orderId, newStatus });  
  };

  if (isLoading) return \<div className="p-8"\>\<span\>Loading all orders...\</span\>\</div\>;

  return (  
    \<div className="p-8"\>  
      \<h1 className="text-3xl font-bold mb-6"\>Manage All Orders\</h1\>  
      \<Table\>  
        \<TableHeader\>  
          \<TableRow\>  
            \<TableHead\>Order \#\</TableHead\>  
            \<TableHead\>Date\</TableHead\>  
            \<TableHead\>Status\</TableHead\>  
            \<TableHead\>Actions\</TableHead\>  
          \</TableRow\>  
        \</TableHeader\>  
        \<TableBody\>  
          {orders?.map(order \=\> (  
            \<TableRow key={order.id}\>  
              \<TableCell\>{order.reference\_number}\</TableCell\>  
              \<TableCell\>{new Date(order.created\_at).toLocaleDateString()}\</TableCell\>  
              \<TableCell\>  
                \<Select  
                  defaultValue={order.status}  
                  onValueChange={(newStatus) \=\> handleStatusChange(order.id, newStatus)}  
                \>  
                  \<SelectTrigger className="w-\[180px\]"\>  
                    \<SelectValue placeholder="Update status" /\>  
                  \</SelectTrigger\>  
                  \<SelectContent\>  
                    \<SelectItem value="Pending"\>Pending\</SelectItem\>  
                    \<SelectItem value="Production"\>Production\</SelectItem\>  
                    \<SelectItem value="Shipped"\>Shipped\</SelectItem\>  
                    \<SelectItem value="Completed"\>Completed\</SelectItem\>  
                    \<SelectItem value="Cancelled"\>Cancelled\</SelectItem\>  
                  \</SelectContent\>  
                \</Select\>  
              \</TableCell\>  
              \<TableCell\>  
                 \<Button variant="outline" size="sm"\>View Details\</Button\>  
              \</TableCell\>  
            \</TableRow\>  
          ))}  
        \</TableBody\>  
      \</Table\>  
    \</div\>  
  );  
}  
\`\`\`  
