**23\. Development: Marketing CRM \- Contacts Hub\*\***

This step implements the foundation of the marketing suite, as defined in **\*\*Epic 6\*\***. It creates the backend table and the admin-facing UI to manage a central list of all customers and contacts.

**\*\*Actions Taken:\*\***

1\. **\*\*Create Contacts Table:\*\*** A new \`crm_contacts\` table is created in the Supabase database. This table will store contact details and includes a \`tags\` field to support segmentation, as required.  
2\. **\*\*Create CRM API:\*\*** New API functions (\`getContacts\`, \`addContact\`, \`updateContactTags\`) are created for managing CRM contacts. These are secure functions intended for administrative use.  
3\. **\*\*Build Contacts Hub Page:\*\*** A new \`AdminCrmPage.tsx\` component is built. This page serves as the central hub for viewing and managing all contacts. It uses **\*\*React Query\*\*** to fetch the contact list and \`useMutation\` to handle updates.

Here is the SQL for the new **\*\*CRM Contacts Table\*\***:

\`\`\`sql  
\-- File: supabase/migrations/004_create_crm_contacts_table.sql

CREATE TABLE crm_contacts (  
 id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,  
 created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    \-- Can be linked to a user in the auth.users table
    user\_id UUID REFERENCES auth.users(id) UNIQUE,

    email TEXT NOT NULL UNIQUE,
    first\_name TEXT,
    last\_name TEXT,

    \-- An array of text tags for segmentation
    tags TEXT\[\] DEFAULT '{}'::text\[\] \--

);  
\`\`\`

Here is the code for the new **\*\*CRM API functions\*\***:

\`\`\`typescript  
// File: src/api/admin/crm.ts

import { supabase } from "@/lib/supabaseClient";

export const getContacts \= async () \=\> {  
 const { data, error } \= await supabase.from('crm_contacts').select('\*');  
 if (error) throw new Error(error.message);  
 return data;  
}

export const updateContactTags \= async ({ contactId, tags }: { contactId: number, tags: string\[\] }) \=\> {  
 const { data, error } \= await supabase  
 .from('crm_contacts')  
 .update({ tags })  
 .eq('id', contactId)  
 .select()  
 .single();  
 if (error) throw new Error(error.message);  
 return data;  
}  
\`\`\`

Here is the code for the **\*\*Admin CRM Contacts Page\*\***:

\`\`\`typescript  
// File: src/pages/admin/AdminCrmPage.tsx

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';  
import { getContacts, updateContactTags } from '@/api/admin/crm';  
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';  
import { Badge } from '@/components/ui/badge';  
import { Button } from '@/components/ui/button';  
import { Input } from '@/components/ui/input';

export function AdminCrmPage() {  
 const queryClient \= useQueryClient();  
 const { data: contacts, isLoading } \= useQuery({ queryKey: \['contacts'\], queryFn: getContacts });

    const updateTagsMutation \= useMutation({
        mutationFn: updateContactTags,
        onSuccess: () \=\> {
            queryClient.invalidateQueries({ queryKey: \['contacts'\] });
        },
    });

    const handleAddTag \= (contactId: number, existingTags: string\[\]) \=\> {
        const newTag \= prompt("Enter a new tag:");
        if (newTag && \!existingTags.includes(newTag)) {
            updateTagsMutation.mutate({ contactId, tags: \[...existingTags, newTag\] });
        }
    };

    if (isLoading) return \<div className="p-8"\>\<span\>Loading contacts...\</span\>\</div\>;

    return (
        \<div className="p-8"\>
            \<h1 className="text-3xl font-bold mb-6"\>CRM Contacts\</h1\>
            \<Table\>
                \<TableHeader\>
                    \<TableRow\>
                        \<TableHead\>Email\</TableHead\>
                        \<TableHead\>Tags\</TableHead\>
                        \<TableHead\>Actions\</TableHead\>
                    \</TableRow\>
                \</TableHeader\>
                \<TableBody\>
                    {contacts?.map(contact \=\> (
                        \<TableRow key={contact.id}\>
                            \<TableCell\>{contact.email}\</TableCell\>
                            \<TableCell className="flex gap-1"\>
                                {contact.tags.map((tag: string) \=\> \<Badge key={tag}\>{tag}\</Badge\>)}
                            \</TableCell\>
                            \<TableCell\>
                                \<Button size="sm" onClick={() \=\> handleAddTag(contact.id, contact.tags)}\>
                                    Add Tag
                                \</Button\>
                            \</TableCell\>
                        \</TableRow\>
                    ))}
                \</TableBody\>
            \</Table\>
        \</div\>
    );

}  
\`\`\`
