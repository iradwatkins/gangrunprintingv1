import { type NextRequest, NextResponse } from 'next/server'

import { prisma } from '@/lib/prisma-singleton'
import { createProductService } from '@/services/ProductService'
import { createProductRepository } from '@/repositories/ProductRepository'
import { transformSizeGroup } from '@/lib/utils/size-transformer'
import {
  transformAddonSets,
  transformLegacyAddons,
  findDefaultAddons,
} from '@/lib/utils/addon-transformer'

// Helper function to calculate price display (from addon-transformer)
function calculatePriceDisplay(addon: any): { price: number; priceDisplay: string } {
  const config = addon.configuration as any

  if (config) {
    if (config.displayPrice) {
      return { price: 0, priceDisplay: config.displayPrice }
    } else if (config.price !== undefined) {
      return { price: config.price, priceDisplay: `$${config.price}` }
    } else if (config.basePrice !== undefined) {
      return { price: config.basePrice, priceDisplay: `$${config.basePrice}` }
    } else if (config.percentage !== undefined) {
      return { price: config.percentage, priceDisplay: `${config.percentage}%` }
    } else if (config.pricePerUnit !== undefined) {
      return { price: config.pricePerUnit, priceDisplay: `$${config.pricePerUnit}/pc` }
    }
  }

  // Fallback based on pricing model
  switch (addon.pricingModel) {
    case 'FIXED_FEE':
    case 'FLAT':
      return { price: 0, priceDisplay: 'Variable' }
    case 'PERCENTAGE':
      return { price: 0, priceDisplay: 'Variable %' }
    case 'PER_UNIT':
      return { price: 0, priceDisplay: 'Per Unit' }
    default:
      return { price: 0, priceDisplay: 'Variable' }
  }
}

// Helper function to transform quantity values
function transformQuantityValues(quantityGroup: any) {
  if (!quantityGroup?.values) return []

  const values = quantityGroup.values.split(',').map((v: string) => v.trim())
  const quantities = values.map((value: string, index: number) => {
    // Check if this is the Custom option
    if (value.toLowerCase() === 'custom') {
      return {
        id: `qty_custom`,
        value: null, // Custom has no preset value
        label: 'Custom',
        isCustom: true,
        customMin: quantityGroup.customMin || 55000,
        customMax: quantityGroup.customMax || 100000,
      }
    }

    // Regular quantity option
    const numValue = parseInt(value)
    return {
      id: `qty_${index}`,
      value: numValue,
      label: value,
      isCustom: false,
    }
  })

  return quantities
}

// Dynamic configuration - will be replaced with real data
const SIMPLE_CONFIG = {
  quantities: [], // Will be populated dynamically
  sizes: [
    {
      id: 'size_0',
      name: '11x17',
      displayName: '11″ × 17″',
      width: 11,
      height: 17,
      squareInches: 187,
      priceMultiplier: 1.0,
      isDefault: false,
    },
    {
      id: 'size_1',
      name: '12x18',
      displayName: '12″ × 18″',
      width: 12,
      height: 18,
      squareInches: 216,
      priceMultiplier: 1.15,
      isDefault: false,
    },
    {
      id: 'size_2',
      name: '18x24',
      displayName: '18″ × 24″',
      width: 18,
      height: 24,
      squareInches: 432,
      priceMultiplier: 2.3,
      isDefault: true,
    },
    {
      id: 'size_3',
      name: '24x36',
      displayName: '24″ × 36″',
      width: 24,
      height: 36,
      squareInches: 864,
      priceMultiplier: 4.6,
      isDefault: false,
    },
    {
      id: 'size_4',
      name: '36x48',
      displayName: '36″ × 48″',
      width: 36,
      height: 48,
      squareInches: 1728,
      priceMultiplier: 9.2,
      isDefault: false,
    },
  ],
  paperStocks: [
    {
      id: 'paper_1',
      name: '14pt C2S Poster Stock',
      description: 'Heavy coated stock with semi-gloss finish',
      pricePerUnit: 0.05,
      coatings: [
        { id: 'coating_1', name: 'High Gloss UV', priceMultiplier: 1.0, isDefault: true },
        { id: 'coating_2', name: 'Matte Finish', priceMultiplier: 0.95, isDefault: false },
        { id: 'coating_3', name: 'Satin Finish', priceMultiplier: 1.05, isDefault: false },
      ],
      sides: [
        { id: 'sides_1', name: 'Front Only', priceMultiplier: 1.0, isDefault: true },
        { id: 'sides_2', name: 'Both Sides', priceMultiplier: 1.8, isDefault: false },
      ],
    },
    {
      id: 'paper_2',
      name: '100lb Gloss Text',
      description: 'Premium glossy finish for vibrant colors',
      pricePerUnit: 0.04,
      coatings: [
        { id: 'coating_1', name: 'High Gloss UV', priceMultiplier: 1.0, isDefault: true },
        { id: 'coating_2', name: 'Matte Finish', priceMultiplier: 0.95, isDefault: false },
      ],
      sides: [
        { id: 'sides_1', name: 'Front Only', priceMultiplier: 1.0, isDefault: true },
        { id: 'sides_2', name: 'Both Sides', priceMultiplier: 1.8, isDefault: false },
      ],
    },
    {
      id: 'paper_3',
      name: '80lb Matte Text',
      description: 'Smooth matte finish, no glare',
      pricePerUnit: 0.03,
      coatings: [
        { id: 'coating_2', name: 'Matte Finish', priceMultiplier: 1.0, isDefault: true },
        { id: 'coating_4', name: 'No Coating', priceMultiplier: 0.9, isDefault: false },
      ],
      sides: [
        { id: 'sides_1', name: 'Front Only', priceMultiplier: 1.0, isDefault: true },
        { id: 'sides_2', name: 'Both Sides', priceMultiplier: 1.8, isDefault: false },
      ],
    },
  ],
  addons: [
    {
      id: 'addon_1',
      name: 'Rounded Corners',
      description: 'Round the corners of your prints for a professional finish',
      pricingModel: 'FIXED_FEE',
      price: 15.0,
      priceDisplay: '$15',
      isDefault: false,
      additionalTurnaroundDays: 1,
    },
    {
      id: 'addon_2',
      name: 'Spot UV Coating',
      description: 'High-gloss UV coating applied to specific areas for enhanced visual impact',
      pricingModel: 'FIXED_FEE',
      price: 25.0,
      priceDisplay: '$25',
      isDefault: false,
      additionalTurnaroundDays: 2,
    },
    {
      id: 'addon_3',
      name: 'Lamination',
      description: 'Protective coating that enhances durability and appearance',
      pricingModel: 'PERCENTAGE',
      price: 0.15,
      priceDisplay: '15%',
      isDefault: false,
      additionalTurnaroundDays: 1,
    },
    {
      id: 'addon_4',
      name: 'Die Cutting',
      description: 'Custom shape cutting for unique designs',
      pricingModel: 'FIXED_FEE',
      price: 35.0,
      priceDisplay: '$35',
      isDefault: false,
      additionalTurnaroundDays: 2,
    },
    {
      id: 'addon_5',
      name: 'Foil Stamping',
      description: 'Metallic foil accents for premium appearance',
      pricingModel: 'PERCENTAGE',
      price: 0.2,
      priceDisplay: '20%',
      isDefault: false,
      additionalTurnaroundDays: 3,
    },
  ],
  turnaroundTimes: [
    {
      id: 'turnaround_1',
      name: 'Economy',
      displayName: 'Economy (2-4 Days)',
      description: 'Standard processing time',
      daysMin: 2,
      daysMax: 4,
      pricingModel: 'FLAT',
      basePrice: 0,
      priceMultiplier: 1.0,
      requiresNoCoating: false,
      restrictedCoatings: [],
      isDefault: true,
    },
    {
      id: 'turnaround_2',
      name: 'Fast',
      displayName: 'Fast (1-2 Days)',
      description: 'Expedited processing',
      daysMin: 1,
      daysMax: 2,
      pricingModel: 'PERCENTAGE',
      basePrice: 0,
      priceMultiplier: 1.25,
      requiresNoCoating: false,
      restrictedCoatings: [],
      isDefault: false,
    },
    {
      id: 'turnaround_3',
      name: 'Faster',
      displayName: 'Faster (Tomorrow)',
      description: 'Next day delivery',
      daysMin: 1,
      daysMax: 1,
      pricingModel: 'PERCENTAGE',
      basePrice: 0,
      priceMultiplier: 1.54,
      requiresNoCoating: false,
      restrictedCoatings: [],
      isDefault: false,
    },
    {
      id: 'turnaround_4',
      name: 'Fastest',
      displayName: 'Fastest WITH NO COATING (Today)',
      description: 'Same day processing without coating',
      daysMin: 0,
      daysMax: 0,
      pricingModel: 'PERCENTAGE',
      basePrice: 0,
      priceMultiplier: 4.98,
      requiresNoCoating: true,
      restrictedCoatings: ['coating_1', 'coating_3'],
      isDefault: false,
    },
  ],
  defaults: {
    quantity: 'qty_2',
    size: 'size_2',
    paper: 'paper_1',
    coating: 'coating_1',
    sides: 'sides_1',
    addons: [],
    turnaround: 'turnaround_1',
  },
}

// GET /api/products/[id]/configuration - Fixed quantities implementation
export async function GET(request: NextRequest, { params }: { params: Promise<{ id: string }> }) {
  try {
    const { id: productId } = await params

    if (!productId) {
      return NextResponse.json({ error: 'Product ID is required' }, { status: 400 })
    }

    // Skip service layer for now since getProductConfiguration doesn't exist
    // Focus on the working database implementation

    // Try to fetch quantities from database - skip if size-only
    let quantities = []
    if (!isSizeOnly) {
      quantities = SIMPLE_CONFIG.quantities // Default fallback only if not size-only
    }

    if (!isSizeOnly) {
      try {
        // First get the product's ProductQuantityGroup relationship
        const productQuantityGroup = await prisma.productQuantityGroup.findFirst({
          where: {
            productId,
          },
          include: {
            QuantityGroup: true,
          },
        })

        if (productQuantityGroup?.QuantityGroup) {
          quantities = transformQuantityValues(productQuantityGroup.QuantityGroup)
        } else {
          // Fallback: try to find any active quantity group
          const quantityData = await prisma.quantityGroup.findFirst({
            where: {
              isActive: true,
          },
        })

        if (quantityData) {
          quantities = transformQuantityValues(quantityData)
        }
      }
    } catch (dbError) {
      // Continue with hardcoded fallback
    }

    // Check what modules are enabled (modular architecture) - MOVED UP
    let isQuantityOnly = false;
    let isSizeOnly = false;
    try {
      const [quantityGroups, sizeGroups, paperStockSets, addonSets, turnaroundSets] = await Promise.all([
        prisma.productQuantityGroup.count({ where: { productId } }),
        prisma.productSizeGroup.count({ where: { productId } }),
        prisma.productPaperStockSet.count({ where: { productId } }),
        prisma.productAddOnSet.count({ where: { productId } }),
        prisma.productTurnaroundTimeSet.count({ where: { productId } })
      ]);

      isQuantityOnly = quantityGroups > 0 && sizeGroups === 0 && paperStockSets === 0 && addonSets === 0 && turnaroundSets === 0;
      isSizeOnly = sizeGroups > 0 && quantityGroups === 0 && paperStockSets === 0 && addonSets === 0 && turnaroundSets === 0;
    } catch (e) {
      // Continue with default behavior
    }

    // Try to fetch sizes from database - skip if quantity-only
    let sizes = []

    if (!isQuantityOnly) {
      sizes = SIMPLE_CONFIG.sizes // Default fallback only if not quantity-only

      try {
        // First check if product has assigned size groups
        const productSizeGroup = await prisma.productSizeGroup.findFirst({
          where: { productId },
          include: { SizeGroup: true }
        })

        if (productSizeGroup?.SizeGroup) {
          sizes = transformSizeGroup(productSizeGroup.SizeGroup)
        }
      } catch (dbError) {
        // Continue with hardcoded fallback
      }
    }

    // Try to fetch add-ons from addon sets for this product (simplified like sizes)
    let addons = []

    if (!isQuantityOnly) {
      addons = SIMPLE_CONFIG.addons // Default fallback only if not quantity-only

      try {
      // Get addon sets for this product - simplified like sizes
      const productAddOnSets = await prisma.productAddOnSet.findMany({
        where: {
          productId,
        },
        include: {
          AddOnSet: {
            include: {
              addOnSetItems: {
                include: {
                  AddOn: true,
                },
                orderBy: {
                  sortOrder: 'asc',
                },
              },
            },
          },
        },
        orderBy: {
          sortOrder: 'asc',
        },
      })

      if (productAddOnSets.length > 0) {
        // Transform using the new standardized approach like sizes
        addons = transformAddonSets(productAddOnSets)
      } else {
        // Transform legacy fallback to standardized format
        addons = transformLegacyAddons(SIMPLE_CONFIG.addons)
      }
    } catch (dbError) {
      // Transform legacy fallback to standardized format
      addons = transformLegacyAddons(SIMPLE_CONFIG.addons)
    }
    }

    // Build addonsGrouped for positioning (restore the unique AddOn Set feature)
    let addonsGrouped = {
      aboveDropdown: [],
      inDropdown: [],
      belowDropdown: [],
    }

    if (!isQuantityOnly) {
      try {
      // Get addon sets for this product for positioning
      const productAddOnSetsForGrouping = await prisma.productAddOnSet.findMany({
        where: {
          productId,
        },
        include: {
          AddOnSet: {
            include: {
              addOnSetItems: {
                include: {
                  AddOn: true,
                },
                orderBy: {
                  sortOrder: 'asc',
                },
              },
            },
          },
        },
        orderBy: {
          sortOrder: 'asc',
        },
      })

      if (productAddOnSetsForGrouping.length > 0) {
        const aboveDropdown: any[] = []
        const inDropdown: any[] = []
        const belowDropdown: any[] = []

        // Process each addon set
        for (const productAddOnSet of productAddOnSetsForGrouping) {
          for (const setItem of productAddOnSet.AddOnSet.addOnSetItems) {
            const addon = setItem.AddOn
            const { price, priceDisplay } = calculatePriceDisplay(addon)

            // Format addon data for positioning (keeping legacy format for UI compatibility)
            const formattedAddon = {
              id: addon.id,
              name: addon.name,
              description: addon.description || '',
              pricingModel: addon.pricingModel,
              price,
              priceDisplay,
              configuration: addon.configuration || {},
              isDefault: setItem.isDefault,
              additionalTurnaroundDays: addon.additionalTurnaroundDays || 0,
              displayPosition: setItem.displayPosition,
            }

            // Add to appropriate groups based on displayPosition
            switch (setItem.displayPosition) {
              case 'ABOVE_DROPDOWN':
                aboveDropdown.push(formattedAddon)
                break
              case 'BELOW_DROPDOWN':
                belowDropdown.push(formattedAddon)
                break
              case 'IN_DROPDOWN':
              default:
                inDropdown.push(formattedAddon)
                break
            }
          }
        }

        addonsGrouped = {
          aboveDropdown,
          inDropdown,
          belowDropdown,
        }
      }
    } catch (groupingError) {
      }
    }

    // Try to fetch turnaround times from database
    let turnaroundTimes = []

    if (!isQuantityOnly) {
      turnaroundTimes = SIMPLE_CONFIG.turnaroundTimes // Default fallback only if not quantity-only

      try {
      // Fetch the default turnaround time set for this product
      const productTurnaroundTimeSet = await prisma.productTurnaroundTimeSet.findFirst({
        where: {
          productId,
          isDefault: true,
        },
        include: {
          TurnaroundTimeSet: {
            include: {
              TurnaroundTimeSetItem: {
                include: {
                  TurnaroundTime: true,
                },
                orderBy: {
                  sortOrder: 'asc',
                },
              },
            },
          },
        },
      })

      // If no default set, try to get any assigned set
      const assignedSet =
        productTurnaroundTimeSet ||
        (await prisma.productTurnaroundTimeSet.findFirst({
          where: { productId },
          include: {
            TurnaroundTimeSet: {
              include: {
                TurnaroundTimeSetItem: {
                  include: {
                    TurnaroundTime: true,
                  },
                  orderBy: {
                    sortOrder: 'asc',
                  },
                },
              },
            },
          },
        }))

      if (assignedSet?.turnaroundTimeSet?.TurnaroundTimeSetItem) {
        // Map the database turnaround times to the API format
        turnaroundTimes = assignedSet.turnaroundTimeSet.TurnaroundTimeSetItem.map((item, index) => {
          const tt = item.TurnaroundTime
          return {
            id: `turnaround_${index + 1}`,
            name: tt.name,
            displayName: tt.displayName,
            description: tt.description || '',
            daysMin: tt.daysMin,
            daysMax: tt.daysMax || tt.daysMin,
            pricingModel: tt.pricingModel,
            basePrice: tt.basePrice,
            priceMultiplier: tt.priceMultiplier,
            requiresNoCoating: tt.requiresNoCoating,
            restrictedCoatings: tt.restrictedCoatings || [],
            isDefault: item.isDefault || index === 0, // First one is default if none specified
          }
        })
      } else {
      }
      } catch (dbError) {
        // Continue with hardcoded fallback
      }
    }

    // Already checked above - removed duplicate

    // Build the configuration object with dynamic quantities, sizes, addons and turnaround times
    // If single-module mode, provide minimal required fields for compatibility
    const fallbackConfig = isQuantityOnly ? {
      quantities,
      sizes: [{
        id: 'default_size',
        name: 'Standard',
        displayName: 'Standard',
        width: 3.5,
        height: 2,
        squareInches: 7,
        priceMultiplier: 1.0,
        isDefault: true,
      }],
      paperStocks: [{
        id: 'default_paper',
        name: 'Standard Stock',
        description: 'Standard paper stock',
        pricePerUnit: 0.01,
        coatings: [{ id: 'default_coating', name: 'Standard', priceMultiplier: 1.0, isDefault: true }],
        sides: [{ id: 'default_sides', name: 'Standard', priceMultiplier: 1.0, isDefault: true }],
      }],
      addons: [],
      addonsGrouped: {
        aboveDropdown: [],
        inDropdown: [],
        belowDropdown: [],
      },
      turnaroundTimes: [{
        id: 'default_turnaround',
        name: 'Standard',
        displayName: 'Standard (3 business days)',
        description: 'Standard processing time',
        daysMin: 3,
        daysMax: 3,
        pricingModel: 'FLAT',
        basePrice: 0,
        priceMultiplier: 1.0,
        requiresNoCoating: false,
        restrictedCoatings: [],
        isDefault: true,
      }],
    } : isSizeOnly ? {
      quantities: [{
        id: 'default_quantity',
        label: 'Standard Quantity',
        value: 100,
        priceMultiplier: 1.0,
        isDefault: true,
      }],
      sizes,
      paperStocks: [{
        id: 'default_paper',
        name: 'Standard Stock',
        description: 'Standard paper stock',
        pricePerUnit: 0.01,
        coatings: [{ id: 'default_coating', name: 'Standard', priceMultiplier: 1.0, isDefault: true }],
        sides: [{ id: 'default_sides', name: 'Standard', priceMultiplier: 1.0, isDefault: true }],
      }],
      addons: [],
      addonsGrouped: {
        aboveDropdown: [],
        inDropdown: [],
        belowDropdown: [],
      },
      turnaroundTimes: [{
        id: 'default_turnaround',
        name: 'Standard',
        displayName: 'Standard (3 business days)',
        description: 'Standard processing time',
        daysMin: 3,
        daysMax: 3,
        pricingModel: 'FLAT',
        basePrice: 0,
        priceMultiplier: 1.0,
        requiresNoCoating: false,
        restrictedCoatings: [],
        isDefault: true,
      }],
    } : {
      ...SIMPLE_CONFIG,
      quantities,
      sizes,
      addons,
      addonsGrouped,
      turnaroundTimes,
    }

    // Update the defaults for quantities, sizes, addons and turnaround times
    const updatedDefaults = isQuantityOnly ? {
      quantity: quantities.find((q) => q.value === 5000)?.id || quantities[0]?.id || 'qty_0',
      size: 'default_size',
      paper: 'default_paper',
      coating: 'default_coating',
      sides: 'default_sides',
      addons: [],
      turnaround: 'default_turnaround',
    } : { ...SIMPLE_CONFIG.defaults }

    if (!isQuantityOnly) {
      if (quantities.length > 0) {
        // Default to 5000 or the first available quantity
        const defaultQuantity = quantities.find((q) => q.value === 5000) || quantities[0]
        updatedDefaults.quantity = defaultQuantity.id
      }

      if (sizes.length > 0) {
        // Find default size or use first one
        const defaultSize = sizes.find((s) => s.isDefault) || sizes[0]
        updatedDefaults.size = defaultSize.id
      }

      if (addons.length > 0) {
        // Find default addons (multiple selection unlike sizes)
        updatedDefaults.addons = findDefaultAddons(addons)
      }

      if (turnaroundTimes.length > 0) {
        const defaultTurnaround = turnaroundTimes.find((t) => t.isDefault) || turnaroundTimes[0]
        updatedDefaults.turnaround = defaultTurnaround.id
      }
    }

    fallbackConfig.defaults = updatedDefaults

    // Return configuration with working quantities
    return NextResponse.json(fallbackConfig, {
      status: 200,
      headers: {
        'Content-Type': 'application/json',
        'Cache-Control': 'public, max-age=60',
        'X-API-Version': 'v5-fixed-quantities',
        'X-Product-Id': productId,
        'X-Quantities-Count': quantities.length.toString(),
      },
    })
  } catch (error) {
    // Even on error, return the static config
    console.error('Product configuration error:', error)
    return NextResponse.json(SIMPLE_CONFIG, {
      status: 200,
      headers: {
        'Content-Type': 'application/json',
        'X-API-Version': 'v1-fallback',
      },
    })
  }
}
